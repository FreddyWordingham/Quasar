<textarea id="render-input" class="prism-live language-json fill">
{{ input }}</textarea
>
<hr />
<button id="render-run_button" class="btn btn-primary" onclick="$render.run()">
    Run <i class="bi bi-play-fill"></i>
</button>
<div id="render-progress_bar_continer" class="progress" style="display: none">
    <div
        id="render-progress_bar"
        class="progress-bar progress-bar-striped progress-bar-animated"
        role="progressbar"
        style="width: 0%"
    ></div>
</div>

<script>
    var $render = {
        run: function () {
            $("#render-run_button").hide();
            $("#render-progress_bar_continer").show();

            let config = $("#render-input").val();
            $.ajax({
                url: "/session/id/" + $session_id + "/render",
                type: "post",
                contentType: "application/json",
                data: JSON.stringify({
                    config: config,
                }),
                success: function () {
                    let progress_monitor = setInterval(function () {
                        $.get(
                            "/session/id/" + $session_id + "/render/progress",
                            {},
                            function (response) {
                                let x = response.slice(0, -1);
                                if (response == "FINISHED\n") {
                                    clearInterval(progress_monitor);
                                    $("#render-run_button").show();
                                    $("#render-progress_bar_continer").hide();
                                    $("#render-progress_bar")
                                        .css("width", "0%")
                                        .text("");

                                    $.post(
                                        "/session/id/" +
                                            $session_id +
                                            "/render/stitch",
                                        {},
                                        function (response) {
                                            let url =
                                                "/static/sessions/" +
                                                $session_id +
                                                "/frame_one/colour.png?" +
                                                new Date().getTime();
                                            $("#render-result").attr(
                                                "src",
                                                url
                                            );
                                        }
                                    );
                                } else {
                                    $("#render-progress_bar")
                                        .css("width", x + "%")
                                        .text(x + "%");
                                }
                            }
                        );
                    }, 1000);
                },
                error: function (response) {
                    alert("Error: " + response);
                },
            });
        },

        del: function () {
            $("#render-result").remove();
        },
    };

    $(document).ready(function () {
        $("#display_container").append(
            "<img id='render-result' class='display'></img>"
        );

        $plugin.del["render"] = $render.del;
    });
</script>
